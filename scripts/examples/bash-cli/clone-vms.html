<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
<HEAD>
<TITLE>Enscript Output</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#1F00FF" ALINK="#FF0000" VLINK="#9900DD">
<A NAME="top">
<A NAME="file1">
<H1>clone-vms</H1>

<PRE>
<B><FONT COLOR="#5F9EA0">#!/bin/sh
</FONT></B>
<I><FONT COLOR="#B22222"># Copyright (c) 2006-2007 XenSource, Inc.
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># Permission to use, copy, modify, and distribute this software for any
</FONT></I><I><FONT COLOR="#B22222"># purpose with or without fee is hereby granted, provided that the above
</FONT></I><I><FONT COLOR="#B22222"># copyright notice and this permission notice appear in all copies.
</FONT></I><I><FONT COLOR="#B22222">#
</FONT></I><I><FONT COLOR="#B22222"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
</FONT></I><I><FONT COLOR="#B22222"># WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
</FONT></I><I><FONT COLOR="#B22222"># MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
</FONT></I><I><FONT COLOR="#B22222"># ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
</FONT></I><I><FONT COLOR="#B22222"># WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
</FONT></I><I><FONT COLOR="#B22222"># ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
</FONT></I><I><FONT COLOR="#B22222"># OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
</FONT></I>
<I><FONT COLOR="#B22222"># Allow the path to the 'xe' binary to be overridden by the XE environment variable
</FONT></I><B><FONT COLOR="#A020F0">if</FONT></B> [ -z <B><FONT COLOR="#BC8F8F">&quot;${XE}&quot;</FONT></B> ]; <B><FONT COLOR="#A020F0">then</FONT></B>
  XE=xe
<B><FONT COLOR="#A020F0">fi</FONT></B>

<B><FONT COLOR="#A020F0">if</FONT></B> [ ! -e <B><FONT COLOR="#BC8F8F">&quot;${HOME}/.xe&quot;</FONT></B> ]; <B><FONT COLOR="#A020F0">then</FONT></B>
  <B><FONT COLOR="#DA70D6">read</FONT></B> -p <B><FONT COLOR="#BC8F8F">&quot;Server name: &quot;</FONT></B> SERVER
  <B><FONT COLOR="#DA70D6">read</FONT></B> -p <B><FONT COLOR="#BC8F8F">&quot;Username: &quot;</FONT></B> USERNAME
  <B><FONT COLOR="#DA70D6">read</FONT></B> -p <B><FONT COLOR="#BC8F8F">&quot;Password: &quot;</FONT></B> PASSWORD
  XE=<B><FONT COLOR="#BC8F8F">&quot;${XE} -s ${SERVER} -u ${USERNAME} -pw ${PASSWORD}&quot;</FONT></B>
<B><FONT COLOR="#A020F0">fi</FONT></B>

<I><FONT COLOR="#B22222"># Check there's a vm uuid parameter to the command
</FONT></I><B><FONT COLOR="#A020F0">if</FONT></B> [ $<I><FONT COLOR="#B22222"># -ne 1 ]; then
</FONT></I>	<B><FONT COLOR="#DA70D6">echo</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;usage: $0 &lt;vm_uuid_to_duplicate&gt;&quot;</FONT></B>
	<B><FONT COLOR="#DA70D6">exit</FONT></B> 1
<B><FONT COLOR="#A020F0">fi</FONT></B>
vmuuid=$1

<I><FONT COLOR="#B22222"># Check if there's a VM by the uuid specified
</FONT></I>${XE} vm-list params=uuid | grep -q <B><FONT COLOR="#BC8F8F">&quot; ${vmuuid}$&quot;</FONT></B>
<B><FONT COLOR="#A020F0">if</FONT></B> [ $? -ne 0 ]; <B><FONT COLOR="#A020F0">then</FONT></B>
	<B><FONT COLOR="#DA70D6">echo</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;error: no vm uuid \&quot;${vmuuid}\&quot; found&quot;</FONT></B>
	<B><FONT COLOR="#DA70D6">exit</FONT></B> 2
<B><FONT COLOR="#A020F0">fi</FONT></B>

<I><FONT COLOR="#B22222"># Check the power state of the vm
</FONT></I>name=$(${XE} vm-list uuid=${vmuuid} params=name-label --minimal)
state=$(${XE} vm-list uuid=${vmuuid} params=power-state --minimal)
wasrunning=0

<I><FONT COLOR="#B22222"># If the VM state is running, we shutdown the vm first
</FONT></I><B><FONT COLOR="#A020F0">if</FONT></B> [ <B><FONT COLOR="#BC8F8F">&quot;${state}&quot;</FONT></B> = <B><FONT COLOR="#BC8F8F">&quot;running&quot;</FONT></B> ]; <B><FONT COLOR="#A020F0">then</FONT></B>
	${XE} vm-shutdown uuid=${vmuuid}
	${XE} event-<B><FONT COLOR="#DA70D6">wait</FONT></B> class=vm power-state=halted uuid=${vmuuid}
	wasrunning=1
<B><FONT COLOR="#A020F0">fi</FONT></B>

<I><FONT COLOR="#B22222"># Clone the VM
</FONT></I>newuuid=$(${XE} vm-clone uuid=${vmuuid} new-name-label=cloned_vm)

<I><FONT COLOR="#B22222"># If the VM state was running before cloning, we start it again
</FONT></I><I><FONT COLOR="#B22222"># along with the new VM.
</FONT></I><B><FONT COLOR="#A020F0">if</FONT></B> [ <B><FONT COLOR="#BC8F8F">&quot;$wasrunning&quot;</FONT></B> -eq 1 ]; <B><FONT COLOR="#A020F0">then</FONT></B>
	${XE} vm-start uuid=${vmuuid}
	${XE} vm-start uuid=${newuuid}
<B><FONT COLOR="#A020F0">fi</FONT></B>
</PRE>
<HR>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU enscript 1.6.4</A>.</ADDRESS>
</BODY>
</HTML>
